## 交接内容概述

1.项目：oa项目，主要用来企业内部工作，项目主要分为组织架构、公告、审批、工作流、个人中心5个模块；
`code`
- 组织架构主要功能：人员、部门的增删改查；
- 公告主要功能：公告的增删改查和发布撤回；
- 审批主要功能：员工进行申请审批单及处理审批单；
- 工作流主要功能：配置审批单及审批单的流转；
- 个人中心：员工个人信息的增删改查。

项目架构：主要用django框架，数据库：redis(短信登陆、定时任务),mysql(系统主要数据),elasticsearch(日志)



代码结构：
├── apps
│   ├── account  # 用户应用
│   ├── announcement # 公告
│   ├── contacts 通讯录
│   ├── manage # 管理后台应用
│   ├── ticket  # 审批单应用
│   └── workflow # 工作流应用
├── baizhou_oa
│   ├── __init__.py
│   ├── urls.py  # url路由主入口
│   └── wsgi.py # wsgi配置
├── common
│   ├── base_serializers.py # 序列化基础类
│   ├── core.py # 一些公用函数
│   ├── middleware.py  # 自定义中间件
│   └── stat.py # 程序状态码
├── log 日志文件
├── media
│   ├── ticket_file  # 审批单附件
├── requirements
│   ├── common.txt  # 公共安装包
│   ├── dev.txt # 开发环境安装包
│   ├── pro.txt #生产环境安装包
├── scripts # 脚本
│   ├── __init__.py
│   └── demo_pinyin_script.py # 用户名拼音录入脚本
├── service
│   ├── account # 用户相关服务
│   ├── base_service.py  # 日志入es处理器基础服务
│   ├── common # 通用服务
│   ├── permission # 权限相关服务
│   ├── push_service.py #推送服务
│   ├── redis_pool.py # redis连接池
│   ├── ticket # 审批单相关服务
│   └── workflow # 工作流相关服务
├── settings # 配置文件目录
│   ├── __init__.py
│   ├── common.py # 通用配置
│   ├── conf.py # 一些配置项key
│   ├── config.py # 生产环境配置
├── static # 静态文件
│   ├── avatar # 头像文件
│   ├── signature # 签名文件
├── tasks.py # 定时任务
└── uwsgi.ini # uwsgi配置文件

### 系统主要功能工作流配置：

- 创建一个工作流包括四个部分，创建工作流基础信息、添加工作流的自定义字段、添加状态、添加流转。 在创建和编辑工作流时可以指定对应的管理员， 只有工作流对应的管理员、工作流创建人、超级管理员才有工作流的编辑权限。拥有工作流管理员权限的用户可以新增和维护自己相关 (自己创建的、作为管理员的)的工作流

  #### 基础信息

  工单查看权限校验：开启后，以工单的关联人(创建人、曾经的处理人)的名义调用工单详情接口才可以返回详情信息

  限制表达式：默认”{}”，限制周期({“period”:24} 24小时), 限制次数({“count”:1}在限制周期内只允许提交1次), 限制级别({“level”:1} 针对(1单个用户 2全局)限制周期限制次数,默认特定用户);允许特定人员提交({“allow_persons”:”zhangsan,lisi”}只允许张三提交工单, {“allow_depts”:”1,2”}只允许部门id为1和2的用户提交工单，{“allow_roles”:”1,2”}只允许角色id为1和2的用户提交工单)。符合限制 表达式规则时调用创建工单接口会返回code=-1,同时msg中将有相应的说明

  标题模板：确定通知的标题

  管理员： 工作流的创建人和这里的管理员有权限修改配置此工作流， 另外超级管理员拥有对所有工作流的配置查看权限

  是否需要个人签名：开启后流程需要上传个人签名

  图标：工作流的图标

  查看权限人：被设置为查看权限人，可以在’审批查看'中看到该类型的所有工单列表

  查看权限部门： 被设置为查看权限部门的下属所有人，可以在’审批查看'中看到该类型的所有工单列表

  展现表单：当用户只有查看权限，非当前处理人时，工单详情展示的字段信息，格式["gmt_created","title", "creator"],

  ![image-20220707162826072](交接文档.assets/image-20220707162826072.png)

  #### 自定义字段

  每个类型的工作流有各自不同的字段， 通过自定义字段可以为工作流新增独有的字段

  字段标识：请输入字段的标识,要求英文字母及下划线组成，以字母开头，且不得使用工单基础字段如(sn、title、state_id等字符)

  字段名称：请输入字段的名称，建议中文，如请假原因、服务器规格等

  字段描述：字段描述信息将显示在工单详情的该字段下方

  字段顺序id：工单详情中字段排列顺序。值越小，越靠前,内置字段顺序为: sn:10, title:20, state_id:40, state.state_name:41,participant_info.participant_name:50, participant_info.participant_alias:55,workflow.workflow_name:60,creator:80,gmt_created:100, gmt_modified:120

  默认值：新建工单时，作为该字段的默认值

  布尔显示定义：当为布尔类型时候，可以支持自定义显示形式。{"1":"是","0":"否"}或{"1":"需要","0":"不需要"}，注意数字也需要双引号

  选项：radio,checkbox,select,multiselect类型可供选择的选项，格式为json如:{"1":"中国", "2":"美国"},注意数字也需要引号

  标签：自定义标签，json格式，调用方可根据标签自行处理特殊场景逻辑，数据库里只保存文本内容

  模板：文本域类型字段前端显示时可以将此内容作为字段的placeholder或默认值

  ![image-20220707163350018](交接文档.assets/image-20220707163350018.png)

  #### 状态

  工单会存在各种状态，工单的处理过程也就是工单的状态的变化，对于工作流的状态支持各种灵活的配置

  状态名称：请输入状态的名称,如发起人编辑中，发起人tl审批中，结束等

  状态顺序：此顺序id,用于获取工单step记录的排序用,因为step是顺序的，而工作流是网状的，所以需要指定顺序id以便排序,数字越小越靠前

  状态类型：每个工作流都需要有一个初始状态，一个结束状态，其他为普通状态。初始状态及结束状态无需设置参与人类型及参与人

  是否允许撤回：开启后，工单的创建人可以在工单处于此状态时将工单撤回到初始状态

  参与人类型：初始状态的处理人类型和处理人选择无和留空(状态的处理人仅供状态变化时确定新的处理人用，不会作为流转时目的状态，所以无需配置)， 结束状态处理人类型和处理人也请选择无和留空，因为结束状态无需人再处理

  参与人：个人(username)；多人(多个username以,隔开；部门(部门id，多个部门以逗号隔开)；变量(creator:工单的创建人,creator_tl:工单创建人的直接主管,creator_tl_tl_2:工单创建人的二级主管，多个变量逗号隔开)；工单字段(逗号隔开多个)；等。

  分配方式：直接处理:当前处理人无需接单，主动接单:当前处理人需要先接单再处理，随机分配:工单将随机指定所配置的当前处理人中一个人， 全部处理:当前所有人都需要处理完且处理动作相同才会流转到下个状态

  表单字段：json格式字典存储,包括读写属性1：只读，2：必填，3：可选. 示例：{"gmt_created":1,"title":2, "sn":1}, 内置特殊字段participant_info.participant_name:当前处理人信息(部门名称、角色名称)，state.state_name:当前状态的状态名,workflow.workflow_name:工作流名称

  ![image-20220707164123265](交接文档.assets/image-20220707164123265.png)

  #### 流转

  流转用于定义每个状态之间的变化途径。

  名称：定义流转的名称，表现为工单详情中用户可以点击的操作，如“提交”、“保存”、“同意”、“拒绝”、“完成”、“关闭”等等

  流转类型：流转类型包括常规流转和定时器流转。如果选择定时器流转，需要设定定时器的时间。

  定时器：单位是秒，如果流转配置了定时器，当工单处于这个流转的源状态停留对应定时器的时间后未做任何操作，那么定时器会触发工单自动流转到下个状态。

  源状态：流转的源状态，即这个流转是在某个状态下可以执行

  目标状态：触发流转后工单的状态将改变为这个目标状态。当流转类型为条件流转时，这里的目标状态将无效，以条件表达式中设定的条件目标状态来流转

  条件表达式：流转条件表达式，根据表达式中的条件来确定流转的下个状态，格式为[{"expression":"{days} > 3 and {days} ≤10", "target_state_id":11},{"expression":"{days} >10", "target_state_id":12},{"expression”:”{dept_name}==‘总裁部’ ", "target_state_id":13}] 其中{}用于填充工单的字段key,运算时会换算成实际的值，当符合条件下个状态将变为target_state_id中的值,表达式只支持简单的运算或datetime/time运算.会以首次匹配成功的条件为准，所以多个条件不要有冲突

  属性类型：可用于标识工单的状态:审批通过，被拒绝等，用于判断流转按钮颜色

  是否校验必填项: 默认在用户点击操作的时候需要校验工单表单的必填项,如果设置为否则不检查。用于如”退回”属性的操作，不需要填写表单内容

  ![image-20220707164352680](交接文档.assets/image-20220707164352680.png)

  ------

#### 用户权限

工作流管理员：对工作流进行增删改查

超级管理员 ：拥有系统所有权限

公告管理员 ：对公告进行增删改查，撤回发布

组织架构管理员：人员及部门的增删改查

普通用户：查看系统权限